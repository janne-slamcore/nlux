"use strict";var e=require("@aws-sdk/client-bedrock-runtime"),t=Object.defineProperty,n=(e,n,o)=>((e,n,o)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[n]=o)(e,"symbol"!=typeof n?n+"":n,o);class o extends Error{constructor(e={}){super(e.message),n(this,"exceptionId"),n(this,"message"),n(this,"source"),n(this,"type"),this.message=e.message??"",this.source=e.source,this.type=this.constructor.name,this.exceptionId=e.exceptionId}}class s extends o{}class r extends o{}const i=e=>{if("object"==typeof e&&null!==e){const t=e;if("invalid_api_key"===t.code)return"invalid-api-key";if(t.message&&"string"==typeof t.message&&t.message.toLowerCase().includes("connection error"))return"connection-error"}return null};var a=Object.defineProperty,c=(e,t,n)=>((e,t,n)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n);const h=class t{constructor(t){if(c(this,"__instanceId"),c(this,"client"),c(this,"options"),!t.model||!t.credentials||!t.region)throw new r({source:this.constructor.name,message:"when creating the Bedrock adapter, you must set model, credentials and region"});this.__instanceId=`${this.info.id}-${"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}`,this.options={...t},this.client=new e.BedrockRuntimeClient(t)}get dataTransferMode(){return this.options.dataTransferMode??t.defaultDataTransferMode}get id(){return this.__instanceId}get info(){return{id:"bedrock-adapter",capabilities:{chat:!0,fileUpload:!1,textToSpeech:!1,speechToText:!1}}}async batchText(t){const n=[{role:"user",content:[{text:t}]}];try{const t=await this.client.send(new e.ConverseCommand({modelId:this.options.model,messages:n,inferenceConfig:this.options.inferenceConfig}));return t.output?.message?.content?.[0].text}catch(e){const t=e.message||"An error occurred while sending the message to the Bedrock API";throw new o({source:this.constructor.name,message:t,exceptionId:i(e)??void 0})}}preProcessAiBatchedMessage(e,t){throw new Error("Method not implemented.")}preProcessAiStreamedChunk(e,t){throw new Error("Method not implemented.")}streamText(t,n){Promise.resolve().then(async()=>{const o=[{role:"user",content:[{text:t}]}],s=new e.ConverseStreamCommand({modelId:this.options.model,messages:o,inferenceConfig:this.options.inferenceConfig});try{const e=await this.client.send(s);for await(const t of e.stream)t.contentBlockDelta&&n.next(t.contentBlockDelta.delta?.text);n.complete()}catch(e){const t=e;n.error(t),(e=>{"string"!=typeof e?e&&"function"==typeof e.toString?console.warn(`[nlux] ${e.toString()}`):console.warn("[nlux]"):console.warn(`[nlux] ${e}`)})("An error occurred while sending the message to the Bedrock streaming API: \n"+t.message)}})}};c(h,"defaultDataTransferMode","batch");let d=h;var l=Object.defineProperty,u=(e,t,n)=>((e,t,n)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n);class m{constructor(){u(this,"credentials",null),u(this,"inferenceConfig",null),u(this,"region",null),u(this,"theDataTransferMode","stream"),u(this,"theModel",null),u(this,"withDataTransferModeCalled",!1)}create(){if(!this.theModel)throw new r({source:this.constructor.name,message:'You must provide a model or an endpoint using the "withModel()" method or the "withEndpoint()" method!'});return new d({dataTransferMode:this.theDataTransferMode,model:this.theModel??void 0,credentials:this.credentials??void 0,region:this.region??void 0,inferenceConfig:this.inferenceConfig??void 0})}withCredintial(e){if(null!==this.credentials)throw new s({source:this.constructor.name,message:"Cannot set the cred token more than once"});return this.credentials=e,this}withDataTransferMode(e){if(this.withDataTransferModeCalled)throw new s({source:this.constructor.name,message:"Cannot set the data loading mode more than once"});return this.theDataTransferMode=e,this.withDataTransferModeCalled=!0,this}withInferenceConfig(e){if(null!==this.inferenceConfig)throw new s({source:this.constructor.name,message:"Cannot set the Inference Config more than once"});return this.inferenceConfig=e,this}withModel(e){if(null!==this.theModel)throw new s({source:this.constructor.name,message:"Cannot set the model because a model or an endpoint has already been set"});return this.theModel=e,this}withRegion(e){if(null!==this.region)throw new s({source:this.constructor.name,message:"Cannot set the endpoint because a model or an endpoint has already been set"});return this.region=e,this}}exports.createChatAdapter=()=>new m;
